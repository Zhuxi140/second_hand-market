# 缓存策略选型与接口映射

## 策略与场景

| 策略 | 读流程 | 写流程 | 适用场景 | 注意点 |
|---|---|---|---|---|
| Cache Aside | 先读缓存，miss读库回填 | 先写库，删缓存 | 读多写少 | 双删+延迟删 |
| Read-Through | 读缓存，miss加载库回填 | 同旁路 | 统一读加载 | 加锁防击穿 |
| Write-Through | 读同上 | 同步更新库与缓存 | 写后需强一致 | 事务一致性 |
| Write-Behind | 读同上 | 先写缓存，异步落库 | 非强一致 | 失败补偿复杂 |
| Binlog/CDC | 读同上 | 库事件驱动更新缓存 | 多源变更 | 幂等+延迟 |
| 逻辑过期 | 命中过期标识后台刷新 | 同旁路 | 大对象高成本 | 单航刷新 |
| 双删策略 | — | 写库后删缓存+延迟再删 | 并发读写 | 覆盖交叉窗口 |
| 热点保护 | 本地缓存/合并请求 | 同上 | 爆款详情 | 限流+预热 |
| 防穿透/击穿/雪崩 | 空值/布隆/分散TTL | 同上 | 弱一致读 | 退避策略 |

## Key 规范

| 资源 | Key |
|---|---|
| 用户信息 | user:info:{userSn} |
| 用户地址列表 | user:addresses:{userSn} |
| 商品详情 | product:detail:{productSn} |
| 商品静态派生 | product:statics:{productSn} |
| 列表首页 | product:list:{queryHash}:p1 |
| Token黑名单 | token:black:{role}:{hash} |

## 用户模块 /user

| 接口 | 方法 | Path | 策略 | Key | 失效/刷新 |
|---|---|---|---|---|---|
| 注册 | POST | /user/register | 旁路+注册后预热 | user:info:{sn} | 回填 |
| 登录 | POST | /user/login | 不缓存对象 | — | — |
| 登出 | POST | /user/logout/{userSn} | 写通黑名单 | token:black:{role}:{hash} | TTL=剩余时长 |
| 刷新令牌 | POST | /user/refresh | 旁路读取库+局部写通 | user:info:{sn} | 更新role/userId |
| 获取用户信息 | GET | /user/me/getInfo/{userSn} | 旁路+逻辑过期 | user:info:{sn} | 后台单航刷新 |
| 修改密码 | PUT | /user/me/{userSn}/password | 写库+双删 | user:info:{sn} | 延迟再删 |
| 更新用户信息 | PUT | /user/me/update/{userSn} | 写库+双删 | user:info:{sn} | 集中更新派生 |

## 地址模块 /user/me

| 接口 | 方法 | Path | 策略 | Key | 失效/刷新 |
|---|---|---|---|---|---|
| 获取地址列表 | GET | /user/me/{userSn}/addresses | 旁路+TTL | user:addresses:{sn} | miss回填 |
| 添加地址 | POST | /user/me/{userSn}/addresses | 写库+双删 | user:addresses:{sn} | 延迟再删 |
| 更新地址 | PUT | /user/me/{userSn}/addresses/{addressSn} | 写库+双删 | user:addresses:{sn} | 同上 |
| 删除地址 | DELETE | /user/me/{userSn}/addresses/{addressSn} | 写库+双删 | user:addresses:{sn} | 同上 |

## 商品模块 /product

| 接口 | 方法 | Path | 策略 | Key | 失效/刷新 |
|---|---|---|---|---|---|
| 类目列表 | GET | /product/categories | 读通+长TTL | product:categories | 版本控制 |
| 成色枚举 | GET | /product/conditions | 读通+长TTL | product:conditions | — |
| 二手列表 | GET | /product/shProductList | 旁路或直读库 | product:list:{queryHash}:p1 | 热门短TTL |
| 二手详情 | GET | /product/shProductDetail | 旁路+逻辑过期 | product:detail:{sn} | 集中失效/单航刷新 |
| 修改商品 | POST | /product/updateProduct | 写库+集中失效 | detail/statics/list | 异步重建 |
| 删除商品 | POST | /product/delProduct | 写库+集中失效 | detail/statics/list | 广播失效 |
| 我的商品 | GET | /product/meShProductList | 旁路+短TTL | product:me:list:{userSn} | — |

## 用户商品发布 /user/me

| 接口 | 方法 | Path | 策略 | Key | 失效/刷新 |
|---|---|---|---|---|---|
| 发布商品 | GET | /user/me/publish | 写库后集中预热 | detail/statics | 列表双删 |

## 文件服务 /cos

| 接口 | 方法 | Path | 策略 | Key | 失效/刷新 |
|---|---|---|---|---|---|
| 获取上传凭证 | POST | /cos/upload | 直连COS，短TTL缓存签名 | cos:upload:{digest} | TTL≤5m |
| 确认上传 | POST | /cos/confirm | 不缓存 | — | — |
| 查看签名 | POST | /cos/view | 短TTL缓存签名 | cos:view:{digest} | TTL≤5m |
