# 仿闲鱼二手交易平台接口设计文档（学生版）

## 1. 接口设计原则

### 1.1 RESTful API 设计规范

- 使用HTTP动词表示操作：GET、POST、PUT、DELETE
- 使用名词表示资源：/users、/products、/orders
- 使用复数形式表示集合
- 使用层级结构表示资源关系：/users/{id}/orders

### 1.2 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1640995200000
}
```

### 1.3 分页响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "size": 20
  }
}
```

### 1.4 错误码规范

- 200：成功
- 400：客户端错误
- 401：未授权
- 403：禁止访问
- 404：资源不存在
- 500：服务器错误

## 2. 认证授权

### 2.1 JWT Token 认证

```http
Authorization: Bearer <token>
```

### 2.2 接口权限控制

- 公开接口：无需认证
- 用户接口：需要用户认证
- 管理员接口：需要管理员认证

### 2.3 Redis缓存策略

- **用户信息缓存**：用户登录后缓存用户基本信息，减少数据库查询
- **商品列表缓存**：热门商品列表缓存30分钟，提高查询性能
- **商品详情缓存**：商品详情缓存1小时，浏览量实时更新
- **分类数据缓存**：商品分类数据缓存24小时，很少变动
- **Token黑名单**：用户登出后Token加入Redis黑名单，实现安全登出

## 3. 用户管理接口 🔴

### 3.1 用户注册登录

#### 3.1.1 用户注册

```http
POST /api/v1/auth/register
Content-Type: application/json
```

**请求体：**

```json
{
  "username": "testuser",
  "password": "password123",
  "phone": "13800138000"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userSn": "USR202401010001",
    "username": "testuser",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expireTime": 1640995200000
  }
}
```

#### 3.1.2 用户登录

```http
POST /api/v1/auth/login
Content-Type: application/json
```

**请求体：**

```json
{
  "username": "testuser",
  "password": "password123"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userSn": "USR202401010001",
    "username": "testuser",
    "nickname": "用户昵称",
    "avatar": "https://example.com/avatar.jpg",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expireTime": 1640995200000
  }
}
```

#### 3.1.3 用户登出

```http
POST /api/v1/auth/logout
Authorization: Bearer <token>
```

**请求参数：** 无

**响应体：**

```json
{
  "code": 200,
  "message": "登出成功",
  "data": null
}
```

### 3.2 用户信息管理

#### 3.2.1 获取用户信息

```http
GET /api/v1/users/{userSn}
Authorization: Bearer <token>
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userSn": "USR202401010001",
    "username": "testuser",
    "nickname": "用户昵称",
    "phone": "13800138000",
    "avatar": "https://example.com/avatar.jpg",
    "status": 1,
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

#### 3.2.2 更新用户信息

```http
PUT /api/v1/users/{userSn}
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号

**请求体：**

```json
{
  "nickname": "新昵称",
  "avatar": "https://example.com/avatar.jpg"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

#### 3.2.3 修改密码

```http
PUT /api/v1/users/{userSn}/password
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号

**请求体：**

```json
{
  "oldPassword": "oldpassword",
  "newPassword": "newpassword"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "密码修改成功",
  "data": null
}
```

### 3.3 地址管理

#### 3.3.1 获取用户地址列表

```http
GET /api/v1/users/{userSn}/addresses
Authorization: Bearer <token>
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "addressSn": "ADDR202401010001",
      "consignee": "张三",
      "phone": "13800138000",
      "provinceName": "北京市",
      "cityName": "北京市",
      "districtName": "东城区",
      "detail": "某某街道123号",
      "label": "家",
      "isDefault": true,
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### 3.3.2 添加地址

```http
POST /api/v1/users/{userSn}/addresses
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号

**请求体：**

```json
{
  "consignee": "张三",
  "phone": "13800138000",
  "provinceName": "北京市",
  "cityName": "北京市",
  "districtName": "东城区",
  "detail": "某某街道123号",
  "label": "家",
  "isDefault": true
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "地址添加成功",
  "data": {
    "addressSn": "ADDR202401010001"
  }
}
```

#### 3.3.3 更新地址

```http
PUT /api/v1/users/{userSn}/addresses/{addressSn}
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号
- `addressSn` (路径参数): 地址业务编号

**请求体：**

```json
{
  "consignee": "李四",
  "phone": "13900139000",
  "provinceName": "上海市",
  "cityName": "上海市",
  "districtName": "浦东新区",
  "detail": "某某路456号",
  "label": "公司",
  "isDefault": false
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "地址更新成功",
  "data": null
}
```

#### 3.3.4 删除地址

```http
DELETE /api/v1/users/{userSn}/addresses/{addressSn}
Authorization: Bearer <token>
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号
- `addressSn` (路径参数): 地址业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "地址删除成功",
  "data": null
}
```

## 4. 商品管理接口 🔴

### 4.1 商品分类

#### 4.1.1 获取分类列表

```http
GET /api/v1/categories
```

**响应：**

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "数码产品",
      "parentId": 0,
      "children": [
        {
          "id": 2,
          "name": "手机",
          "parentId": 1
        }
      ]
    }
  ]
}
```

### 4.2 商品管理

#### 4.2.1 发布商品

```http
POST /api/v1/products
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体：**

```json
{
  "title": "iPhone 13 Pro Max",
  "description": "99新iPhone 13 Pro Max，无磕碰",
  "categorySn": "CAT202401010002",
  "price": 6999.00,
  "condition": 2,
  "location": "北京市朝阳区",
  "images": [
    {
      "url": "https://example.com/image1.jpg",
      "type": 1,
      "sortOrder": 1
    }
  ]
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "商品发布成功",
  "data": {
    "productSn": "PRD202401010001"
  }
}
```

#### 4.2.2 获取商品列表

```http
GET /api/v1/products?page=1&size=20&categorySn=CAT202401010002&keyword=iPhone&minPrice=1000&maxPrice=10000&location=北京&sortBy=price&sortOrder=asc
```

**请求参数：**

- `page` (查询参数): 页码，默认1
- `size` (查询参数): 每页数量，默认20
- `categorySn` (查询参数): 分类业务编号
- `keyword` (查询参数): 搜索关键词
- `minPrice` (查询参数): 最低价格
- `maxPrice` (查询参数): 最高价格
- `location` (查询参数): 地区
- `sortBy` (查询参数): 排序字段（price, time, viewCount）
- `sortOrder` (查询参数): 排序方向（asc, desc）

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "productSn": "PRD202401010001",
        "title": "iPhone 13 Pro Max",
        "price": 6999.00,
        "condition": 2,
        "location": "北京市朝阳区",
        "viewCount": 156,
        "sellerSn": "USR202401010001",
        "sellerNickname": "卖家昵称",
        "coverImage": "https://example.com/cover.jpg",
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "size": 20
  }
}
```

#### 4.2.3 获取商品详情

```http
GET /api/v1/products/{productSn}
```

**请求参数：**

- `productSn` (路径参数): 商品业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "productSn": "PRD202401010001",
    "title": "iPhone 13 Pro Max",
    "description": "99新iPhone 13 Pro Max，无磕碰",
    "categorySn": "CAT202401010002",
    "categoryName": "手机",
    "price": 6999.00,
    "condition": 2,
    "conditionText": "9成新",
    "status": 1,
    "statusText": "在售",
    "location": "北京市朝阳区",
    "viewCount": 156,
    "sellerSn": "USR202401010001",
    "sellerNickname": "卖家昵称",
    "sellerAvatar": "https://example.com/avatar.jpg",
    "images": [
      {
        "url": "https://example.com/image1.jpg",
        "type": 1,
        "sortOrder": 1
      }
    ],
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

#### 4.2.4 更新商品

```http
PUT /api/v1/products/{productSn}
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数：**

- `productSn` (路径参数): 商品业务编号

**请求体：**

```json
{
  "title": "iPhone 13 Pro Max 更新",
  "description": "更新后的描述",
  "price": 6500.00,
  "condition": 3,
  "location": "北京市海淀区"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "商品更新成功",
  "data": null
}
```

#### 4.2.5 删除商品

```http
DELETE /api/v1/products/{productSn}
Authorization: Bearer <token>
```

**请求参数：**

- `productSn` (路径参数): 商品业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "商品删除成功",
  "data": null
}
```

#### 4.2.6 获取我的商品

```http
GET /api/v1/users/{userSn}/products?page=1&size=20&status=1
Authorization: Bearer <token>
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号
- `page` (查询参数): 页码，默认1
- `size` (查询参数): 每页数量，默认20
- `status` (查询参数): 商品状态

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "productSn": "PRD202401010001",
        "title": "iPhone 13 Pro Max",
        "price": 6999.00,
        "status": 1,
        "statusText": "在售",
        "viewCount": 156,
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 10,
    "page": 1,
    "size": 20
  }
}
```

### 4.3 商品图片

#### 4.3.1 上传商品图片

```http
POST /api/v1/products/images/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <image_file>
```

#### 4.3.2 删除商品图片

```http
DELETE /api/v1/products/{productId}/images/{imageId}
Authorization: Bearer <token>
```

## 5. 订单管理接口 🔴

### 5.1 订单操作

#### 5.1.1 创建订单

```http
POST /api/v1/orders
Authorization: Bearer <token>
Content-Type: application/json
```

**请求体：**

```json
{
  "items": [
    {
      "productSn": "PRD202401010001",
      "quantity": 1
    }
  ],
  "receiveAddressSn": "ADDR202401010001",
  "remark": "请尽快发货"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "订单创建成功",
  "data": {
    "orderSn": "ORD202401010001"
  }
}
```

#### 5.1.2 获取订单列表

```http
GET /api/v1/users/{userSn}/orders?page=1&size=20&status=1&type=buyer
Authorization: Bearer <token>
```

**请求参数：**

- `userSn` (路径参数): 用户业务编号
- `page` (查询参数): 页码，默认1
- `size` (查询参数): 每页数量，默认20
- `status` (查询参数): 订单状态
- `type` (查询参数): 订单类型（buyer: 作为买家, seller: 作为卖家）

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "orderSn": "ORD202401010001",
        "totalAmount": 6999.00,
        "status": 1,
        "statusText": "待付款",
        "productCount": 1,
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 10,
    "page": 1,
    "size": 20
  }
}
```

#### 5.1.3 获取订单详情

```http
GET /api/v1/orders/{orderSn}
Authorization: Bearer <token>
```

**请求参数：**

- `orderSn` (路径参数): 订单业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "orderSn": "ORD202401010001",
    "buyerSn": "USR202401010001",
    "buyerNickname": "买家昵称",
    "totalAmount": 6999.00,
    "status": 1,
    "statusText": "待付款",
    "receiveAddress": {
      "addressSn": "ADDR202401010001",
      "consignee": "张三",
      "phone": "13800138000",
      "fullAddress": "北京市东城区某某街道123号"
    },
    "items": [
      {
        "productSn": "PRD202401010001",
        "productTitle": "iPhone 13 Pro Max",
        "productImage": "https://example.com/cover.jpg",
        "quantity": 1,
        "unitPrice": 6999.00,
        "sellerSn": "USR202401010002",
        "sellerNickname": "卖家昵称"
      }
    ],
    "remark": "请尽快发货",
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

#### 5.1.4 取消订单

```http
PUT /api/v1/orders/{orderSn}/cancel
Authorization: Bearer <token>
Content-Type: application/json
```

**请求参数：**

- `orderSn` (路径参数): 订单业务编号

**请求体：**

```json
{
  "reason": "不想要了"
}
```

**响应体：**

```json
{
  "code": 200,
  "message": "订单取消成功",
  "data": null
}
```

#### 5.1.5 确认收货

```http
PUT /api/v1/orders/{orderSn}/confirm
Authorization: Bearer <token>
```

**请求参数：**

- `orderSn` (路径参数): 订单业务编号

**响应体：**

```json
{
  "code": 200,
  "message": "确认收货成功",
  "data": null
}
```

### 5.2 订单状态管理

#### 5.2.1 更新订单状态（卖家）

```http
PUT /api/v1/orders/{orderId}/status
Authorization: Bearer <token>
Content-Type: application/json

{
  "status": 2,
  "remark": "已发货，快递单号：SF1234567890"
}
```

## 6. 收藏接口 🔴

### 6.1 收藏管理

#### 6.1.1 收藏商品

```http
POST /api/v1/users/{userId}/collections
Authorization: Bearer <token>
Content-Type: application/json

{
  "productId": 1
}
```

#### 6.1.2 取消收藏

```http
DELETE /api/v1/users/{userId}/collections/{productId}
Authorization: Bearer <token>
```

#### 6.1.3 获取收藏列表

```http
GET /api/v1/users/{userId}/collections?page=1&size=20
Authorization: Bearer <token>
```

## 7. 搜索接口 🔴

### 7.1 搜索功能

#### 7.1.1 商品搜索

```http
GET /api/v1/search/products?q=iPhone&page=1&size=20&filters={"categoryId":2,"minPrice":1000,"maxPrice":10000}
```

#### 7.1.2 搜索建议

```http
GET /api/v1/search/suggestions?q=iPh
```

## 8. 文件上传接口 🔴

### 8.1 文件上传

#### 8.1.1 上传图片

```http
POST /api/v1/upload/image
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <image_file>
```

#### 8.1.2 上传头像

```http
POST /api/v1/upload/avatar
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <avatar_file>
```

## 9. 通讯接口 🟡

### 9.1 聊天管理

#### 9.1.1 获取会话列表

```http
GET /api/v1/chat/conversations
Authorization: Bearer <token>
```

#### 9.1.2 获取聊天记录

```http
GET /api/v1/chat/conversations/{conversationId}/messages?page=1&size=50
Authorization: Bearer <token>
```

#### 9.1.3 发送消息

```http
POST /api/v1/chat/messages
Authorization: Bearer <token>
Content-Type: application/json

{
  "conversationId": "conv_123",
  "receiverId": 2,
  "content": "你好，这个商品还在吗？",
  "type": "text"
}
```

#### 9.1.4 标记消息已读

```http
PUT /api/v1/chat/messages/{messageId}/read
Authorization: Bearer <token>
```

### 9.2 WebSocket 实时通讯

#### 9.2.1 连接WebSocket

```javascript
const ws = new WebSocket('ws://localhost:8080/ws/chat?token=<jwt_token>');
```

## 10. 评价接口 🟡

### 10.1 评价管理

#### 10.1.1 创建评价

```http
POST /api/v1/orders/{orderId}/comment
Authorization: Bearer <token>
Content-Type: application/json

{
  "rating": 5,
  "comment": "商品很好，卖家很nice！"
}
```

#### 10.1.2 获取用户评价

```http
GET /api/v1/users/{userId}/comments?page=1&size=20
```

## 11. 系统管理接口 🟡

### 11.1 管理员接口

#### 11.1.1 管理员登录

```http
POST /api/v1/admin/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

#### 11.1.2 获取用户列表

```http
GET /api/v1/admin/users?page=1&size=20&status=1
Authorization: Bearer <admin_token>
```

#### 11.1.3 审核商品

```http
PUT /api/v1/admin/products/{productId}/audit
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "status": "approved",
  "remark": "审核通过"
}
```

#### 11.1.4 分类管理

```http
GET /api/v1/admin/categories
POST /api/v1/admin/categories
PUT /api/v1/admin/categories/{categoryId}
DELETE /api/v1/admin/categories/{categoryId}
```

## 12. 接口实现要点

### 12.1 必做功能实现 🔴

#### 12.1.1 用户认证

- 使用Spring Security + JWT
- 密码使用BCrypt加密
- 实现登录拦截器

#### 12.1.2 商品管理

- 文件上传使用MultipartFile
- 图片存储到本地或云存储
- 使用PageHelper实现分页

#### 12.1.3 订单管理

- 使用@Transactional保证事务
- 订单状态使用枚举管理
- 使用乐观锁处理并发

#### 12.1.4 缓存优化

- 使用Redis缓存热门商品
- 缓存用户信息
- 缓存分类数据

### 12.2 选做功能实现 🟡

#### 12.2.1 通讯功能

- 使用WebSocket实现实时通讯
- 消息存储到数据库
- 实现在线状态管理

#### 12.2.2 评价系统

- 实现评分计算逻辑
- 评价数据统计展示

### 12.3 技术难点

#### 12.3.1 性能优化

- 数据库查询优化
- Redis缓存策略
- 分页查询优化

#### 12.3.2 并发处理

- 乐观锁处理库存
- 分布式锁实现
- 消息队列异步处理

## 13. 接口测试

### 13.1 测试工具

- Postman：接口测试
- Swagger：接口文档和测试
- JUnit：单元测试

### 13.2 测试用例

- 正常流程测试
- 异常情况测试
- 边界值测试
- 并发测试

## 14. 部署说明

### 14.1 开发环境

- 本地MySQL数据库
- 本地Redis服务
- 本地RabbitMQ服务

### 14.2 生产环境

- 云服务器部署
- Docker容器化
- Nginx反向代理

### 14.3 配置管理

- application.yml配置文件
- 环境变量配置
- 数据库连接池配置
