# 仿闲鱼二手交易平台接口设计文档

## 1. 接口设计原则

### 1.1 RESTful API 设计规范
- 使用HTTP动词表示操作：GET、POST、PUT、DELETE
- 使用名词表示资源：/users、/products、/orders
- 使用复数形式表示集合
- 使用层级结构表示资源关系：/users/{id}/orders

### 1.2 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1640995200000,
  "requestId": "req_123456789"
}
```

### 1.3 分页响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

### 1.4 错误码规范
- 2xx：成功
- 4xx：客户端错误
- 5xx：服务端错误

## 2. 认证授权

### 2.1 JWT Token 认证
```http
Authorization: Bearer <token>
```

### 2.2 接口权限控制
- 公开接口：无需认证
- 用户接口：需要用户认证
- 管理员接口：需要管理员认证

## 3. 用户管理接口

### 3.1 用户注册登录

#### 3.1.1 用户注册
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123",
  "phone": "13800138000",
  "email": "test@example.com",
  "type": 1
}
```

**响应：**
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": 1,
    "username": "testuser",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

#### 3.1.2 用户登录
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

#### 3.1.3 刷新Token
```http
POST /api/v1/auth/refresh
Authorization: Bearer <token>
```

#### 3.1.4 用户登出
```http
POST /api/v1/auth/logout
Authorization: Bearer <token>
```

### 3.2 用户信息管理

#### 3.2.1 获取用户信息
```http
GET /api/v1/users/{userId}
Authorization: Bearer <token>
```

#### 3.2.2 更新用户信息
```http
PUT /api/v1/users/{userId}
Authorization: Bearer <token>
Content-Type: application/json

{
  "nickname": "新昵称",
  "avatar": "https://example.com/avatar.jpg",
  "email": "newemail@example.com"
}
```

#### 3.2.3 修改密码
```http
PUT /api/v1/users/{userId}/password
Authorization: Bearer <token>
Content-Type: application/json

{
  "oldPassword": "oldpassword",
  "newPassword": "newpassword"
}
```

### 3.3 地址管理

#### 3.3.1 获取用户地址列表
```http
GET /api/v1/users/{userId}/addresses
Authorization: Bearer <token>
```

#### 3.3.2 添加地址
```http
POST /api/v1/users/{userId}/addresses
Authorization: Bearer <token>
Content-Type: application/json

{
  "consignee": "张三",
  "phone": "13800138000",
  "provinceCode": "110000",
  "provinceName": "北京市",
  "cityCode": "110100",
  "cityName": "北京市",
  "districtCode": "110101",
  "districtName": "东城区",
  "detail": "某某街道123号",
  "label": "家",
  "isDefault": true
}
```

#### 3.3.3 更新地址
```http
PUT /api/v1/users/{userId}/addresses/{addressId}
Authorization: Bearer <token>
Content-Type: application/json
```

#### 3.3.4 删除地址
```http
DELETE /api/v1/users/{userId}/addresses/{addressId}
Authorization: Bearer <token>
```

## 4. 商品管理接口

### 4.1 商品分类

#### 4.1.1 获取分类列表
```http
GET /api/v1/categories
```

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "数码产品",
      "parentId": 0,
      "iconUrl": "https://example.com/icon.png",
      "children": [
        {
          "id": 2,
          "name": "手机",
          "parentId": 1,
          "iconUrl": "https://example.com/phone.png"
        }
      ]
    }
  ]
}
```

#### 4.1.2 获取分类详情
```http
GET /api/v1/categories/{categoryId}
```

### 4.2 商品管理

#### 4.2.1 发布商品
```http
POST /api/v1/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "iPhone 13 Pro Max",
  "description": "99新iPhone 13 Pro Max，无磕碰",
  "categoryId": 2,
  "price": 6999.00,
  "condition": 2,
  "location": "北京市朝阳区",
  "images": [
    {
      "url": "https://example.com/image1.jpg",
      "type": 1,
      "sortOrder": 1
    }
  ],
  "specs": [
    {
      "specifications": {"color": "深空灰", "storage": "256GB"},
      "price": 6999.00,
      "stock": 1
    }
  ]
}
```

#### 4.2.2 获取商品列表
```http
GET /api/v1/products?page=1&size=20&categoryId=2&keyword=iPhone&minPrice=1000&maxPrice=10000&location=北京&sortBy=price&sortOrder=asc
```

**查询参数：**
- page: 页码
- size: 每页数量
- categoryId: 分类ID
- keyword: 搜索关键词
- minPrice: 最低价格
- maxPrice: 最高价格
- location: 地区
- sortBy: 排序字段（price, time, viewCount）
- sortOrder: 排序方向（asc, desc）

#### 4.2.3 获取商品详情
```http
GET /api/v1/products/{productId}
```

#### 4.2.4 更新商品
```http
PUT /api/v1/products/{productId}
Authorization: Bearer <token>
Content-Type: application/json
```

#### 4.2.5 删除商品
```http
DELETE /api/v1/products/{productId}
Authorization: Bearer <token>
```

#### 4.2.6 获取我的商品
```http
GET /api/v1/users/{userId}/products?page=1&size=20&status=1
Authorization: Bearer <token>
```

### 4.3 商品图片

#### 4.3.1 上传商品图片
```http
POST /api/v1/products/images/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <image_file>
```

#### 4.3.2 删除商品图片
```http
DELETE /api/v1/products/{productId}/images/{imageId}
Authorization: Bearer <token>
```

## 5. 订单管理接口

### 5.1 订单操作

#### 5.1.1 创建订单
```http
POST /api/v1/orders
Authorization: Bearer <token>
Content-Type: application/json

{
  "items": [
    {
      "productId": 1,
      "skuId": 1,
      "quantity": 1
    }
  ],
  "receiveAddressId": 1,
  "remark": "请尽快发货"
}
```

#### 5.1.2 获取订单列表
```http
GET /api/v1/users/{userId}/orders?page=1&size=20&status=1&type=buyer
Authorization: Bearer <token>
```

**查询参数：**
- type: 订单类型（buyer: 作为买家, seller: 作为卖家）
- status: 订单状态

#### 5.1.3 获取订单详情
```http
GET /api/v1/orders/{orderId}
Authorization: Bearer <token>
```

#### 5.1.4 取消订单
```http
PUT /api/v1/orders/{orderId}/cancel
Authorization: Bearer <token>
Content-Type: application/json

{
  "reason": "不想要了"
}
```

#### 5.1.5 确认收货
```http
PUT /api/v1/orders/{orderId}/confirm
Authorization: Bearer <token>
```

#### 5.1.6 申请退款
```http
POST /api/v1/orders/{orderId}/refund
Authorization: Bearer <token>
Content-Type: application/json

{
  "reason": "商品与描述不符",
  "images": ["https://example.com/evidence.jpg"]
}
```

### 5.2 订单状态管理

#### 5.2.1 更新订单状态（卖家）
```http
PUT /api/v1/orders/{orderId}/status
Authorization: Bearer <token>
Content-Type: application/json

{
  "status": 2,
  "remark": "已发货，快递单号：SF1234567890"
}
```

## 6. 通讯接口

### 6.1 聊天管理

#### 6.1.1 获取会话列表
```http
GET /api/v1/chat/conversations
Authorization: Bearer <token>
```

#### 6.1.2 获取聊天记录
```http
GET /api/v1/chat/conversations/{conversationId}/messages?page=1&size=50
Authorization: Bearer <token>
```

#### 6.1.3 发送消息
```http
POST /api/v1/chat/messages
Authorization: Bearer <token>
Content-Type: application/json

{
  "conversationId": "conv_123",
  "receiverId": 2,
  "content": "你好，这个商品还在吗？",
  "type": "text"
}
```

#### 6.1.4 标记消息已读
```http
PUT /api/v1/chat/messages/{messageId}/read
Authorization: Bearer <token>
```

### 6.2 WebSocket 实时通讯

#### 6.2.1 连接WebSocket
```javascript
const ws = new WebSocket('ws://localhost:8080/ws/chat?token=<jwt_token>');
```

#### 6.2.2 消息格式
```json
{
  "type": "message",
  "data": {
    "conversationId": "conv_123",
    "senderId": 1,
    "receiverId": 2,
    "content": "你好",
    "timestamp": 1640995200000
  }
}
```

## 7. 评价接口

### 7.1 评价管理

#### 7.1.1 创建评价
```http
POST /api/v1/orders/{orderId}/comment
Authorization: Bearer <token>
Content-Type: application/json

{
  "rating": 5,
  "comment": "商品很好，卖家很nice！",
  "images": ["https://example.com/comment.jpg"]
}
```

#### 7.1.2 获取用户评价
```http
GET /api/v1/users/{userId}/comments?page=1&size=20
```

#### 7.1.3 回复评价
```http
POST /api/v1/comments/{commentId}/reply
Authorization: Bearer <token>
Content-Type: application/json

{
  "reply": "谢谢您的评价！"
}
```

## 8. 收藏接口

### 8.1 收藏管理

#### 8.1.1 收藏商品
```http
POST /api/v1/users/{userId}/collections
Authorization: Bearer <token>
Content-Type: application/json

{
  "productId": 1
}
```

#### 8.1.2 取消收藏
```http
DELETE /api/v1/users/{userId}/collections/{productId}
Authorization: Bearer <token>
```

#### 8.1.3 获取收藏列表
```http
GET /api/v1/users/{userId}/collections?page=1&size=20
Authorization: Bearer <token>
```

## 9. 商铺管理接口

### 9.1 商铺申请

#### 9.1.1 申请成为商铺
```http
POST /api/v1/shops/apply
Authorization: Bearer <token>
Content-Type: application/json

{
  "shopName": "我的小店",
  "description": "专业销售数码产品",
  "logoUrl": "https://example.com/logo.jpg",
  "businessLicense": "https://example.com/license.jpg"
}
```

#### 9.1.2 获取商铺信息
```http
GET /api/v1/shops/{shopId}
```

#### 9.1.3 更新商铺信息
```http
PUT /api/v1/shops/{shopId}
Authorization: Bearer <token>
Content-Type: application/json
```

### 9.2 商铺商品管理

#### 9.2.1 获取商铺商品
```http
GET /api/v1/shops/{shopId}/products?page=1&size=20
```

#### 9.2.2 批量管理商品
```http
PUT /api/v1/shops/{shopId}/products/batch
Authorization: Bearer <token>
Content-Type: application/json

{
  "action": "updateStatus",
  "productIds": [1, 2, 3],
  "status": 2
}
```

## 10. 搜索接口

### 10.1 搜索功能

#### 10.1.1 商品搜索
```http
GET /api/v1/search/products?q=iPhone&page=1&size=20&filters={"categoryId":2,"minPrice":1000,"maxPrice":10000}
```

#### 10.1.2 搜索建议
```http
GET /api/v1/search/suggestions?q=iPh
```

#### 10.1.3 热门搜索
```http
GET /api/v1/search/hot
```

## 11. 文件上传接口

### 11.1 文件上传

#### 11.1.1 上传图片
```http
POST /api/v1/upload/image
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <image_file>
```

#### 11.1.2 上传头像
```http
POST /api/v1/upload/avatar
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <avatar_file>
```

## 12. 系统管理接口

### 12.1 管理员接口

#### 12.1.1 管理员登录
```http
POST /api/v1/admin/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

#### 12.1.2 获取用户列表
```http
GET /api/v1/admin/users?page=1&size=20&status=1
Authorization: Bearer <admin_token>
```

#### 12.1.3 审核商品
```http
PUT /api/v1/admin/products/{productId}/audit
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "status": "approved",
  "remark": "审核通过"
}
```

#### 12.1.4 处理举报
```http
POST /api/v1/admin/reports/{reportId}/handle
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "action": "warning",
  "remark": "已警告用户"
}
```

## 13. 接口扩展性设计

### 13.1 版本控制
- 使用URL版本控制：/api/v1/、/api/v2/
- 向后兼容：保持旧版本接口可用
- 渐进式升级：新功能使用新版本

### 13.2 插件化架构
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "product": {...},
    "extensions": {
      "recommendations": [...],
      "promotions": [...],
      "reviews": [...]
    }
  }
}
```

### 13.3 微服务接口
- 用户服务：/api/v1/users/*
- 商品服务：/api/v1/products/*
- 订单服务：/api/v1/orders/*
- 通讯服务：/api/v1/chat/*
- 支付服务：/api/v1/payments/*

### 13.4 事件驱动接口
```http
POST /api/v1/events
Content-Type: application/json

{
  "eventType": "order.created",
  "data": {
    "orderId": 123,
    "userId": 456,
    "amount": 100.00
  }
}
```

## 14. 接口安全

### 14.1 请求限流
- 基于IP的限流
- 基于用户的限流
- 基于接口的限流

### 14.2 参数验证
- 必填参数验证
- 参数类型验证
- 参数长度验证
- 参数格式验证

### 14.3 数据脱敏
- 敏感信息脱敏
- 日志脱敏
- 响应数据脱敏

## 15. 接口监控

### 15.1 性能监控
- 响应时间监控
- 吞吐量监控
- 错误率监控

### 15.2 业务监控
- 接口调用量
- 用户行为分析
- 业务指标监控

### 15.3 告警机制
- 异常告警
- 性能告警
- 业务告警