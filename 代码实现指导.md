# 仿闲鱼项目代码实现指导

## 🚀 立即开始：完善项目配置

### 1. 完善server模块依赖

首先，你需要完善 `server/pom.xml` 文件，添加所有必要的依赖：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.5.5</version>
        <relativePath/>
    </parent>
    <groupId>com.zhuxi</groupId>
    <artifactId>server</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>server</name>
    <description>server</description>
    
    <properties>
        <java.version>17</java.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- MyBatis Plus -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.3.1</version>
        </dependency>
        
        <!-- MySQL驱动 -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.33</version>
        </dependency>
        
        <!-- Redis -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        
        <!-- RabbitMQ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>
        
        <!-- Spring Security -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        
        <!-- 参数验证 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        
        <!-- JWT -->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>0.12.3</version>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>0.12.3</version>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>0.12.3</version>
        </dependency>
        
        <!-- 工具类 -->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.8.22</version>
        </dependency>
        
        <!-- 分页插件 -->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.4.7</version>
        </dependency>
        
        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        
        <!-- 测试 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

### 2. 创建配置文件

创建 `server/src/main/resources/application.yml`：

```yaml
server:
  port: 8080

spring:
  application:
    name: secondhand-market
  
  # 数据库配置
  datasource:
    url: jdbc:mysql://localhost:3306/secondhand?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  
  # Redis配置
  redis:
    host: localhost
    port: 6379
    database: 0
    timeout: 5000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
  
  # RabbitMQ配置
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
    virtual-host: /

# MyBatis Plus配置
mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.zhuxi.pojo.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0

# 分页配置
pagehelper:
  helper-dialect: mysql
  reasonable: true
  support-methods-arguments: true

# 日志配置
logging:
  level:
    com.zhuxi: debug
    org.springframework.security: debug
```

## 📁 项目结构创建

### 1. 创建目录结构

在IDEA中创建以下目录结构：

```
server/src/main/java/com/zhuxi/server/
├── config/                 # 配置类
├── controller/             # 控制器
├── service/                # 服务层
│   └── impl/              # 服务实现
├── mapper/                 # 数据访问层
├── handler/                # 异常处理器
├── interceptor/            # 拦截器
└── aspect/                 # 切面

server/src/main/resources/
├── mapper/                 # MyBatis映射文件
└── application.yml         # 配置文件
```

## 🔧 核心代码实现

### 1. 公共模块代码

#### 统一响应结果类

**common/src/main/java/com/zhuxi/common/result/Result.java**
```java
package com.zhuxi.common.result;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class Result<T> {
    private Integer code;
    private String message;
    private T data;
    private Long timestamp;
    
    public static <T> Result<T> success() {
        return new Result<>(200, "success", null, System.currentTimeMillis());
    }
    
    public static <T> Result<T> success(T data) {
        return new Result<>(200, "success", data, System.currentTimeMillis());
    }
    
    public static <T> Result<T> success(String message, T data) {
        return new Result<>(200, message, data, System.currentTimeMillis());
    }
    
    public static <T> Result<T> error(String message) {
        return new Result<>(500, message, null, System.currentTimeMillis());
    }
    
    public static <T> Result<T> error(Integer code, String message) {
        return new Result<>(code, message, null, System.currentTimeMillis());
    }
}
```

#### 分页结果类

**common/src/main/java/com/zhuxi/common/result/PageResult.java**
```java
package com.zhuxi.common.result;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.util.List;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class PageResult<T> {
    private List<T> list;
    private Long total;
    private Integer page;
    private Integer size;
    private Integer totalPages;
    
    public static <T> PageResult<T> of(List<T> list, Long total, Integer page, Integer size) {
        PageResult<T> result = new PageResult<>();
        result.setList(list);
        result.setTotal(total);
        result.setPage(page);
        result.setSize(size);
        result.setTotalPages((int) Math.ceil((double) total / size));
        return result;
    }
}
```

#### 业务异常类

**common/src/main/java/com/zhuxi/common/exception/BusinessException.java**
```java
package com.zhuxi.common.exception;

import lombok.Data;
import lombok.EqualsAndHashCode;

@Data
@EqualsAndHashCode(callSuper = true)
public class BusinessException extends RuntimeException {
    private Integer code;
    private String message;
    
    public BusinessException(String message) {
        super(message);
        this.code = 500;
        this.message = message;
    }
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
}
```

#### JWT工具类

**common/src/main/java/com/zhuxi/common/utils/JwtUtil.java**
```java
package com.zhuxi.common.utils;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.springframework.stereotype.Component;

import java.util.Date;

@Component
public class JwtUtil {
    private static final String SECRET = "secondhand-market-secret-key-2024";
    private static final int EXPIRE_TIME = 7 * 24 * 60 * 60 * 1000; // 7天
    
    public String generateToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRE_TIME))
                .signWith(SignatureAlgorithm.HS512, SECRET)
                .compact();
    }
    
    public String getUsernameFromToken(String token) {
        Claims claims = Jwts.parser()
                .setSigningKey(SECRET)
                .parseClaimsJws(token)
                .getBody();
        return claims.getSubject();
    }
    
    public boolean isTokenExpired(String token) {
        try {
            Claims claims = Jwts.parser()
                    .setSigningKey(SECRET)
                    .parseClaimsJws(token)
                    .getBody();
            return claims.getExpiration().before(new Date());
        } catch (Exception e) {
            return true;
        }
    }
    
    public boolean validateToken(String token, String username) {
        try {
            String tokenUsername = getUsernameFromToken(token);
            return username.equals(tokenUsername) && !isTokenExpired(token);
        } catch (Exception e) {
            return false;
        }
    }
}
```

### 2. 实体类代码

#### 用户实体类

**POJO/src/main/java/com/zhuxi/pojo/entity/User.java**
```java
package com.zhuxi.pojo.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@TableName("user")
public class User {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String userSn;
    private String username;
    private String password;
    private String nickname;
    private String email;
    private String phone;
    private String avatar;
    private Integer status;
    private String role;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
}
```

#### 商品实体类

**POJO/src/main/java/com/zhuxi/pojo/entity/Product.java**
```java
package com.zhuxi.pojo.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@TableName("product")
public class Product {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String productSn;
    private Long sellerId;
    private Long shopId;
    private String title;
    private String description;
    private Long categoryId;
    private BigDecimal price;
    private Integer condition;
    private Integer status;
    private String location;
    private Integer viewCount;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createdAt;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updatedAt;
}
```

### 3. DTO类代码

#### 用户注册DTO

**POJO/src/main/java/com/zhuxi/pojo/DTO/UserRegisterDTO.java**
```java
package com.zhuxi.pojo.DTO;

import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Pattern;
import javax.validation.constraints.Email;

@Data
public class UserRegisterDTO {
    @NotBlank(message = "用户名不能为空")
    private String username;
    
    @NotBlank(message = "密码不能为空")
    @Pattern(regexp = "^.{6,20}$", message = "密码长度必须在6-20位之间")
    private String password;
    
    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;
    
    @Email(message = "邮箱格式不正确")
    private String email;
    
    private String nickname;
}
```

#### 登录DTO

**POJO/src/main/java/com/zhuxi/pojo/DTO/LoginDTO.java**
```java
package com.zhuxi.pojo.DTO;

import lombok.Data;
import javax.validation.constraints.NotBlank;

@Data
public class LoginDTO {
    @NotBlank(message = "用户名不能为空")
    private String username;
    
    @NotBlank(message = "密码不能为空")
    private String password;
}
```

#### 登录响应DTO

**POJO/src/main/java/com/zhuxi/pojo/DTO/LoginResponseDTO.java**
```java
package com.zhuxi.pojo.DTO;

import lombok.Data;

@Data
public class LoginResponseDTO {
    private String userSn;
    private String username;
    private String nickname;
    private String avatar;
    private String token;
    private Long expireTime;
}
```

### 4. Mapper层代码

#### 用户Mapper接口

**server/src/main/java/com/zhuxi/server/mapper/UserMapper.java**
```java
package com.zhuxi.server.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.zhuxi.pojo.entity.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface UserMapper extends BaseMapper<User> {
    User selectByUsername(@Param("username") String username);
    User selectByPhone(@Param("phone") String phone);
    User selectByEmail(@Param("email") String email);
}
```

#### 用户Mapper XML

**server/src/main/resources/mapper/UserMapper.xml**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhuxi.server.mapper.UserMapper">
    
    <select id="selectByUsername" resultType="com.zhuxi.pojo.entity.User">
        SELECT * FROM user WHERE username = #{username}
    </select>
    
    <select id="selectByPhone" resultType="com.zhuxi.pojo.entity.User">
        SELECT * FROM user WHERE phone = #{phone}
    </select>
    
    <select id="selectByEmail" resultType="com.zhuxi.pojo.entity.User">
        SELECT * FROM user WHERE email = #{email}
    </select>
    
</mapper>
```

### 5. Service层代码

#### 用户Service接口

**server/src/main/java/com/zhuxi/server/service/UserService.java**
```java
package com.zhuxi.server.service;

import com.zhuxi.common.result.Result;
import com.zhuxi.pojo.DTO.LoginDTO;
import com.zhuxi.pojo.DTO.LoginResponseDTO;
import com.zhuxi.pojo.DTO.UserRegisterDTO;

public interface UserService {
    Result<String> register(UserRegisterDTO registerDTO);
    Result<LoginResponseDTO> login(LoginDTO loginDTO);
}
```

#### 用户Service实现

**server/src/main/java/com/zhuxi/server/service/impl/UserServiceImpl.java**
```java
package com.zhuxi.server.service.impl;

import com.zhuxi.common.exception.BusinessException;
import com.zhuxi.common.result.Result;
import com.zhuxi.common.utils.JwtUtil;
import com.zhuxi.pojo.DTO.LoginDTO;
import com.zhuxi.pojo.DTO.LoginResponseDTO;
import com.zhuxi.pojo.DTO.UserRegisterDTO;
import com.zhuxi.pojo.entity.User;
import com.zhuxi.server.mapper.UserMapper;
import com.zhuxi.server.service.UserService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.time.LocalDateTime;
import java.util.UUID;

@Service
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    private final BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();
    
    @Override
    public Result<String> register(UserRegisterDTO registerDTO) {
        // 1. 检查用户名是否已存在
        User existUser = userMapper.selectByUsername(registerDTO.getUsername());
        if (existUser != null) {
            throw new BusinessException("用户名已存在");
        }
        
        // 2. 检查手机号是否已存在
        if (StringUtils.hasText(registerDTO.getPhone())) {
            User existPhone = userMapper.selectByPhone(registerDTO.getPhone());
            if (existPhone != null) {
                throw new BusinessException("手机号已存在");
            }
        }
        
        // 3. 检查邮箱是否已存在
        if (StringUtils.hasText(registerDTO.getEmail())) {
            User existEmail = userMapper.selectByEmail(registerDTO.getEmail());
            if (existEmail != null) {
                throw new BusinessException("邮箱已存在");
            }
        }
        
        // 4. 创建用户
        User user = new User();
        BeanUtils.copyProperties(registerDTO, user);
        user.setUserSn("USR" + System.currentTimeMillis() + UUID.randomUUID().toString().substring(0, 6));
        user.setPassword(passwordEncoder.encode(registerDTO.getPassword()));
        user.setStatus(1);
        user.setRole("user");
        user.setCreatedAt(LocalDateTime.now());
        user.setUpdatedAt(LocalDateTime.now());
        
        userMapper.insert(user);
        
        return Result.success("注册成功");
    }
    
    @Override
    public Result<LoginResponseDTO> login(LoginDTO loginDTO) {
        // 1. 根据用户名查询用户
        User user = userMapper.selectByUsername(loginDTO.getUsername());
        if (user == null) {
            throw new BusinessException("用户名或密码错误");
        }
        
        // 2. 验证密码
        if (!passwordEncoder.matches(loginDTO.getPassword(), user.getPassword())) {
            throw new BusinessException("用户名或密码错误");
        }
        
        // 3. 检查用户状态
        if (user.getStatus() != 1) {
            throw new BusinessException("用户账号已被禁用");
        }
        
        // 4. 生成token
        String token = jwtUtil.generateToken(user.getUsername());
        
        // 5. 构建响应
        LoginResponseDTO response = new LoginResponseDTO();
        response.setUserSn(user.getUserSn());
        response.setUsername(user.getUsername());
        response.setNickname(user.getNickname());
        response.setAvatar(user.getAvatar());
        response.setToken(token);
        response.setExpireTime(System.currentTimeMillis() + 7 * 24 * 60 * 60 * 1000);
        
        return Result.success("登录成功", response);
    }
}
```

### 6. Controller层代码

#### 用户Controller

**server/src/main/java/com/zhuxi/server/controller/UserController.java**
```java
package com.zhuxi.server.controller;

import com.zhuxi.common.result.Result;
import com.zhuxi.pojo.DTO.LoginDTO;
import com.zhuxi.pojo.DTO.LoginResponseDTO;
import com.zhuxi.pojo.DTO.UserRegisterDTO;
import com.zhuxi.server.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@RestController
@RequestMapping("/api/v1/auth")
@CrossOrigin(origins = "*")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @PostMapping("/register")
    public Result<String> register(@RequestBody @Valid UserRegisterDTO registerDTO) {
        return userService.register(registerDTO);
    }
    
    @PostMapping("/login")
    public Result<LoginResponseDTO> login(@RequestBody @Valid LoginDTO loginDTO) {
        return userService.login(loginDTO);
    }
}
```

### 7. 异常处理器

**server/src/main/java/com/zhuxi/server/handler/GlobalExceptionHandler.java**
```java
package com.zhuxi.server.handler;

import com.zhuxi.common.exception.BusinessException;
import com.zhuxi.common.result.Result;
import org.springframework.validation.BindException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.List;

@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<Void> handleValidationException(MethodArgumentNotValidException e) {
        List<FieldError> fieldErrors = e.getBindingResult().getFieldErrors();
        StringBuilder sb = new StringBuilder();
        for (FieldError fieldError : fieldErrors) {
            sb.append(fieldError.getDefaultMessage()).append("; ");
        }
        return Result.error(400, sb.toString());
    }
    
    @ExceptionHandler(BindException.class)
    public Result<Void> handleBindException(BindException e) {
        List<FieldError> fieldErrors = e.getBindingResult().getFieldErrors();
        StringBuilder sb = new StringBuilder();
        for (FieldError fieldError : fieldErrors) {
            sb.append(fieldError.getDefaultMessage()).append("; ");
        }
        return Result.error(400, sb.toString());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        e.printStackTrace();
        return Result.error(500, "系统内部错误");
    }
}
```

## 🚀 启动和测试

### 1. 启动项目

```bash
# 进入server目录
cd server

# 启动项目
mvn spring-boot:run
```

### 2. 测试接口

#### 测试注册接口
```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456",
    "phone": "13800138000",
    "email": "test@example.com",
    "nickname": "测试用户"
  }'
```

#### 测试登录接口
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456"
  }'
```

## 📋 下一步开发计划

完成用户认证模块后，按照以下顺序继续开发：

1. **商品管理模块**
   - 商品发布
   - 商品列表查询
   - 商品详情
   - 商品编辑删除

2. **订单管理模块**
   - 订单创建
   - 订单状态管理
   - 订单查询

3. **地址管理模块**
   - 地址CRUD操作
   - 默认地址设置

4. **搜索功能**
   - 关键词搜索
   - 分类筛选
   - 价格排序

每个模块都按照相同的开发模式进行，确保代码的一致性和可维护性。
